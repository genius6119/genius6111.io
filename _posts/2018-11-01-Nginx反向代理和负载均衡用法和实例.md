---
layout:     post
title:      Nginx反向代理和负载均衡的原理和实例
subtitle:   ——在两台学生机上的实际例子
date:       2018-11-01
author:     Zwx
header-img: img/home-bg-art.jpg
catalog: true
tags:
    - Linux
---

---
## Nginx

>Nginx (engine x) 是一个高性能的HTTP和反向代理服务，也是一个IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。
>
>其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。
>
> Nginx是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。

百度百科是这样说的，总而言之nginx就是个Web服务器。那有人就纳闷了，Tomcat也是Web服务器，它俩有什么区别呢？

#### nginx和tomcat的区别
>web上的server都叫web server，但是大家分工也有不同的。
 >
>nginx常用做静态内容服务和代理服务器（不是你翻墙那个代理），直面外来请求转发给后面的应用服务（tomcat等），
>
>tomcat更多用来做做一个应用容器，让java web app跑在里面的东西。

---
## 反向代理

提反向代理之前必须要了解正向代理，用我自己的话总结一下：

- 正向代理： 客户端 告诉 同一内网下的代理服务器 自己要访问哪个外网，代理服务器访问这个外网服务器，把内容存到自己这里，然后把内容返回到客户端。客户端知道要访问的具体服务器地址（也有可能是另一个代理服务器），被访问的服务器并不知道是哪个客户端访问的它。（翻墙就是用的正向代理）
- 反向代理： 代理服务器 接受 因特网（外网）上某个 客户端 的请求，代理服务器按照一定的规则，访问某一个内网服务器，把内容存到自己这里，然后把内容返回到客户端。客户端只知道自己访问了个代理服务器，不知道自己访问的是哪一个具体的服务器。

左边是正向代理，右边是反向代理：
![](http://pic.zwxzzz.top/nginx.jpg)

---
## 负载均衡

　　当一台服务器的性能达到极限时，我们可以使用服务器集群来提高网站的整体性能。那么，在服务器集群中，需要有一台服务器充当调度者的角色，用户的所有请求都会首先由它接收，调度者再根据每台服务器的负载情况将请求分配给某一台后端服务器去处理。用我的话说就是请求分发给不同服务器，降低单个服务器的压力。那么在这个过程中，调度者如何合理分配任务，保证所有后端服务器都将性能充分发挥，从而保持服务器集群的整体性能最优，这就是负载均衡问题。

---
## nginx安装

直接照着：[百度](https://www.baidu.com/s?ie=utf-8&f=8&rsv_bp=1&tn=baidu&wd=centos7%20nginx%E5%AE%89%E8%A3%85%20&oq=nginx%25E5%25AE%2589%25E8%25A3%2585%2520centos7&rsv_pq=bfebe9660002b572&rsv_t=384aNvt4%2FBe4gTkflvfnKKIwQcGEFXbo3XCqlsN59LrTqnNDNLFHaOGNfX0&rqlang=cn&rsv_enter=0&inputT=4727&rsv_sug3=12&rsv_sug1=10&rsv_sug7=100&rsv_n=2&rsv_sug4=4727)  安装。
安装完成目录效果：
![](http://pic.zwxzzz.top/aznginx.jpg)

---
## nginx配置文件
默认的配置文件是`/etc/nginx/nginx.conf`，打开内容如下：
```

user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

	
	
    include /etc/nginx/conf.d/*.conf;
}

```
发现它还include了`/conf.d`文件夹下的所有`.conf`文件，打开这个文件夹发现有一个`default.conf`配置文件，打开：
```
server {
    listen       80;
    server_name  localhost;

    #charset koi8-r;
    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
		proxy_pass http://127.0.0.1:8080/;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}
```
其中带#都是被注释掉的东西，第一次看不用关注。

#### nginx配置文件结构
```
...              #全局块

events {         #events块
   ...
}

http      #http块
{
    ...   #http全局块
    server        #server块
    { 
        ...       #server全局块
        location [PATTERN]   #location块
        {
            ...
        }
        location [PATTERN] 
        {
            ...
        }
    }
    server
    {
      ...
    }
    ...     #http全局块
}
```
- 全局块：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。

- events块：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。

- http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。

- server块：配置虚拟主机的相关参数，一个http中可以有多个server。

- location块：配置请求的路由，以及各种页面的处理情况。

#### 详解
```
user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  65;
    #gzip  on;

    server {
        listen       80;
        server_name  localhost;
    
        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
    		proxy_pass http://127.0.0.1:8080/;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        } 
    }
}

```



   
   